{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  .full-height {
    height: calc(100vh - 56px);
  }

  .sidebar {
    width: 350px;
    background-color: #f8f9fa;
    overflow-y: auto;
  }

  .map-area {
    flex-grow: 1;
    height: 100%;
    position: relative; /* ë²„íŠ¼ ìœ„ì¹˜ ì ˆëŒ€ ì§€ì •ìš© */
  }

  .list-group-item {
    margin: 0;
    padding-left: 12px;
    padding-right: 12px;
    border-left: none;
    border-right: none;
  }

  .sidebar {
    width: 350px;
    height: calc(100vh - 56px);
    display: flex;
    flex-direction: column;
  }

  .sidebar h5 {
    height: 4rem;
    line-height: 2rem;
    margin: 0;
    padding: 0 1rem;
    border-bottom: 1px solid #dee2e6;
    flex-shrink: 0;
  }

  .sidebar ul.list-group {
    flex-grow: 1;
    overflow-y: auto;
    margin: 0;
    padding: 0;
  }

  .location-button {
    position: absolute;
    bottom: 30px;
    right: 10px;
    z-index: 10;
    width: 40px;
    height: 40px;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 5px;
    cursor: pointer;
    box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .location-button img {
    width: 22px;
    height: 22px;
  }
</style>

<div class="container-fluid p-0 m-0">
  <div class="d-flex full-height">

    <!-- ğŸ…¿ï¸ ì™¼ìª½ ì£¼ì°¨ì¥ ëª©ë¡ -->
    <div class="sidebar d-flex flex-column">
      <h5 class="p-3 m-0 border-bottom flex-shrink-0">ì£¼ì°¨ì¥ ëª©ë¡</h5>
      <ul class="list-group list-group-flush flex-grow-1 overflow-auto">
        {% for b in basics %}
          <li class="list-group-item parking-item" data-name="{{ b.name }}">
            <div class="fw-bold">{{ b.name }}</div>
            ì´ êµ¬íš: {{ b.total }}<br>
            ê°€ìš© ëŒ€ìˆ˜: {{ b.avblPklotCnt }}<br>
            ì œê³µ ì‹œê°„: {{ b.ocrnDt }}<br>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- ğŸ—ºï¸ ì˜¤ë¥¸ìª½ ì§€ë„ -->
    <div class="map-area">
      <div id="map" style="width:100%; height:100%;"></div>
      <button class="location-button" onclick="moveToCurrentLocation()">
        <img src="{% static 'imgs/location_icon.png' %}" alt="ë‚´ ìœ„ì¹˜">
      </button>
    </div>

  </div>
</div>

<!-- ğŸ“Œ Kakao ì§€ë„ API -->
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=863559e6bebce003983f160e07c1ac27&libraries=services"></script>

<script>
    const mapContainer = document.getElementById('map');
    const fixedLat = 37.6822186;
    const fixedLng = 126.769498;
    let currentMarker = null;
    let currentCircle = null;

    const locPosition = new kakao.maps.LatLng(fixedLat, fixedLng);
    const mapOption = { center: locPosition, level: 4 };
    const map = new kakao.maps.Map(mapContainer, mapOption);

    map.setZoomable(false);


    const basics = JSON.parse('{{ basics_json|escapejs }}');
    const cameras = JSON.parse('{{ cctv_json|escapejs }}');
    const availability = JSON.parse('{{ availability_json|escapejs }}');

    const infowindow = new kakao.maps.InfoWindow({});
    const markerMap = {};

    // ì£¼ì°¨ì¥ ë§ˆì»¤ìš© ì´ë¯¸ì§€ ìƒì„± (ì˜ˆ: parking_marker.png)
    const parkingMarkerImage = new kakao.maps.MarkerImage(
      "{% static 'imgs/parking-area.png' %}",
      new kakao.maps.Size(35, 35), // ì•„ì´ì½˜ í¬ê¸° ì¡°ì ˆ
      {
        offset: new kakao.maps.Point(20, 40) // ë§ˆì»¤ì˜ ê¸°ì¤€ì ì„ ì•„ì´ì½˜ ì•„ë˜ ì¤‘ì•™ìœ¼ë¡œ ì§€ì •
      }
    );

    // ì´ˆê¸° "ë‚´ìœ„ì¹˜" í‘œì‹œ (ê³ ì •ëœ ìœ„ì¹˜)
    currentMarker = new kakao.maps.Marker({
        position: locPosition,
        map: map,
        title: 'ë‚´ìœ„ì¹˜'
    });

    currentCircle = new kakao.maps.Circle({
        center: locPosition,
        radius: 500,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        fillColor: '#FF0000',
        fillOpacity: 0.1,
        map: map
    });

    // ì£¼ì°¨ì¥ ë§ˆì»¤ ìƒì„±
    basics.forEach(b => {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(b.lat, b.lng),
            title: b.name,
            map: map,
            image: parkingMarkerImage
        });
        marker.isOpen = false;
        markerMap[b.name] = marker;

        kakao.maps.event.addListener(marker, 'click', () => {
            toggleInfowindow(marker, b.name);
        });
    });

    // CCTV ë§ˆì»¤ ì´ë¯¸ì§€
    const cameraMarkerImage = new kakao.maps.MarkerImage(
    "{% static 'imgs/security-camera.png' %}",  // ê²½ë¡œ ìˆ˜ì •
    new kakao.maps.Size(30, 30)  // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ (ì›í•˜ëŠ” í¬ê¸°ë¡œ ìˆ˜ì • ê°€ëŠ¥)
    );

    cameras.forEach(c => {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(c.lat, c.lng),
            title: c.name,
            map: map,
            image: cameraMarkerImage
        });

        marker.isOpen = false;

        kakao.maps.event.addListener(marker, 'click', () => {
            if (marker.isOpen) {
                infowindow.close();
                marker.isOpen = false;
            } else {
                infowindow.close();
                infowindow.setContent(`
                    <div class="card" style="width: 18rem; margin:0;">
                        <div class="card-body">
                            <h5 class="card-title">${c.name}</h5>
                        </div>
                    </div>
                `);
                infowindow.open(map, marker);
                marker.isOpen = true;
            }
        });
    });

    availability.forEach(a => {
        const b = basics.find(b => b.name === a.name);
        if (!b) return;

        const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(b.lat, b.lng),
        title: b.name,
        map: map,
        image: parkingMarkerImage
    });


        marker.isOpen = false;

        kakao.maps.event.addListener(marker, 'click', () => {
            toggleInfowindow(marker, a.name);
        });

        markerMap[a.name] = marker;
    });

    function toggleInfowindow(marker, name) {
    const b = basics.find(b => b.name === name);
    if (!b) return;

    if (marker.isOpen) {
        infowindow.close();
        marker.isOpen = false;
    } else {
        infowindow.close();

        infowindow.setContent(`
            <div class="card shadow-sm" style="width: 300px; font-size: 14px; overflow-x: hidden;">
                <div class="card-header bg-primary text-white fw-bold text-center">
                    ${b.name}
                </div>

                <div class="card-body p-2">
                    <!-- ë©´ìˆ˜ ì •ë³´ -->
                    <div class="row gx-0 text-center mb-2">
                        <div class="col-6 border-end">
                            <div class="fw-bold">ì´ ë©´ìˆ˜</div>
                            <div>${b.total}</div>
                        </div>
                        <div class="col-6 bg-success text-white">
                            <div class="fw-bold">ê°€ìš© ë©´ìˆ˜</div>
                            <div>${b.avblPklotCnt}</div>
                        </div>
                    </div>

                    <hr>

                    <!-- í‘œ ì •ë³´ -->
                    <table class="table table-sm mb-0">
                        <tbody>
                            <tr>
                                <th scope="row">ì£¼ì†Œ</th>
                                <td>${b.address || 'ì •ë³´ ì—†ìŒ'}</td>
                            </tr>
                            <tr>
                                <th scope="row">ìš´ì˜ì‹œê°„</th>
                                <td>
                                    í‰ì¼: ${b.weekdayTime || '-'}<br>
                                    í† ìš”ì¼: ${b.saturdayTime || '-'}<br>
                                    íœ´ì¼: ${b.holidayTime || '-'}
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">ì£¼ì°¨ìš”ê¸ˆ</th>
                                <td>
                                    ê¸°ë³¸: ${b.basicRate || '-'}<br>
                                    ì¶”ê°€: ${b.addRate || '-'}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `);

        infowindow.open(map, marker);
        marker.isOpen = true;
    }
}



    document.querySelectorAll('.parking-item').forEach(item => {
        item.addEventListener('click', () => {
            const name = item.getAttribute('data-name');
            const marker = markerMap[name];
            if (marker) {
                map.panTo(marker.getPosition());
                toggleInfowindow(marker, name);
            }
        });
    });

    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // âœ… í˜„ìœ„ì¹˜ë¡œ ì´ë™ í•¨ìˆ˜
    function moveToCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const newPosition = new kakao.maps.LatLng(lat, lng);

          map.setCenter(newPosition);

          // ê¸°ì¡´ ë§ˆì»¤/ì› ì œê±°
          if (currentMarker) currentMarker.setMap(null);
          if (currentCircle) currentCircle.setMap(null);

          // ìƒˆ ë§ˆì»¤/ì› ì¶”ê°€
          currentMarker = new kakao.maps.Marker({
            position: newPosition,
            map: map,
            title: 'í˜„ì¬ ìœ„ì¹˜'
          });

          currentCircle = new kakao.maps.Circle({
            center: newPosition,
            radius: 500,
            strokeWeight: 2,
            strokeColor: '#FF0000',
            strokeOpacity: 0.7,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map
          });

          // CCTV ê±°ë¦¬ í™•ì¸
          let cctvNear = false;
          for (let c of cameras) {
            const distance = getDistance(lat, lng, c.lat, c.lng);
            if (distance <= 200) {
              cctvNear = true;
              break;
            }
          }

          if (cctvNear) {
            alert("âš ï¸ ì£¼ì˜: í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ 200m ì´ë‚´ì— CCTVê°€ ìˆìŠµë‹ˆë‹¤.");
          }

        }, function(error) {
          alert("ğŸ“µ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          console.error(error);
        });
      } else {
        alert("ğŸš« ìœ„ì¹˜ ì •ë³´ ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•œ ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
      }
    }
</script>

{% endblock %}
