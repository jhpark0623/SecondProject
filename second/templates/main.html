{% extends 'base.html' %}

{% block content %}

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid">
  <div class="row">

    <!-- ğŸ…¿ï¸ ì™¼ìª½ ì£¼ì°¨ì¥ ë¦¬ìŠ¤íŠ¸ -->
    <div class="col-md-3 bg-light p-3" style="height: 800px; overflow-y: auto;">
      <h5>ì£¼ì°¨ì¥ ëª©ë¡</h5>
      <ul class="list-group">
        {% for b in basics %}
          <li class="list-group-item d-flex justify-content-between align-items-start parking-item" data-name="{{ b.name }}">
            <div>
              <div class="fw-bold">{{ b.name }}</div>
              ì´ êµ¬íš: {{ b.total }}<br>
              ê°€ìš© ëŒ€ìˆ˜: {{ b.avblPklotCnt }}<br>
              ì œê³µ ì‹œê°„: {{ b.ocrnDt }}<br>
              ìœ„ë„: {{ b.lat }}<br>
              ê²½ë„: {{ b.lng }}
            </div>
          </li>
        {% endfor %}


      </ul>
    </div>

    <!-- ğŸ—ºï¸ ì˜¤ë¥¸ìª½ ì§€ë„ -->
    <div class="col-md-9 p-0">
      <div id="map" style="width:100%; height:800px;"></div>
    </div>

  </div>
</div>

<!-- Kakao Maps API -->
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=863559e6bebce003983f160e07c1ac27&libraries=services"></script>

<script>
    var mapContainer = document.getElementById('map');
    var fixedLat = 37.658359;
    var fixedLng = 126.773917;
    var locPosition = new kakao.maps.LatLng(fixedLat, fixedLng);
    var mapOption = { center: locPosition, level: 4 };
    var map = new kakao.maps.Map(mapContainer, mapOption);

    var basics = JSON.parse('{{ basics_json|escapejs }}');
    var cameras = JSON.parse('{{ cameras_json|escapejs }}');
    var availability = JSON.parse('{{ availability_json|escapejs }}');

    var infowindow = new kakao.maps.InfoWindow({});
    var markerMap = {};  // ë§ˆì»¤ë¥¼ ì´ë¦„ìœ¼ë¡œ ì €ì¥

    // ì¤‘ì‹¬ ë§ˆì»¤
    new kakao.maps.Marker({
        position: locPosition,
        map: map,
        title: 'ì •ë°œì‚°ì—­ ê¸°ì¤€ ìœ„ì¹˜'
    });

    // ë°˜ê²½ ì›
    new kakao.maps.Circle({
        center: locPosition,
        radius: 500,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        fillColor: '#FF0000',
        fillOpacity: 0.1,
        map: map
    });

    // ğŸ…¿ï¸ ì£¼ì°¨ì¥ ë§ˆì»¤ ìƒì„±
    basics.forEach(function(b){
        var marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(b.lat, b.lng),
            title: b.name,
            map: map
        });

        marker.isOpen = false;
        markerMap[b.name] = marker;  // ì´ë¦„ìœ¼ë¡œ ë§ˆì»¤ ì €ì¥

        kakao.maps.event.addListener(marker, 'click', function() {
            toggleInfowindow(marker, b.name);
        });
    });

    // ğŸ¥ ì¹´ë©”ë¼ ë§ˆì»¤
    cameras.forEach(function(c){
        var marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(c.lat, c.lng),
            title: c.name,
            map: map
        });

        marker.isOpen = false;
        kakao.maps.event.addListener(marker, 'click', function() {
            if(marker.isOpen){
                infowindow.close();
                marker.isOpen = false;
            } else {
                infowindow.close();
                infowindow.setContent(`
                    <div class="card" style="width: 18rem; margin:0;">
                        <div class="card-body">
                            <h5 class="card-title">${c.name}</h5>
                            <p class="card-text">ì¹´ë©”ë¼ ìœ„ì¹˜</p>
                        </div>
                    </div>
                `);
                infowindow.open(map, marker);
                marker.isOpen = true;
            }
        });
    });

    // â“‚ï¸ ê°€ìš© ì£¼ì°¨ êµ¬íš ë§ˆì»¤
    availability.forEach(function(a){
        var b = basics.find(b => b.name === a.name);
        if(!b) return;

        var marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(b.lat, b.lng),
            title: a.name,
            map: map
        });

        marker.isOpen = false;

        kakao.maps.event.addListener(marker, 'click', function() {
            toggleInfowindow(marker, a.name);
        });

        markerMap[a.name] = marker;  // ë®ì–´ì“°ê¸° ê°€ëŠ¥
    });

    // ğŸ“Œ InfoWindow í† ê¸€ í•¨ìˆ˜
    function toggleInfowindow(marker, name) {
        var a = availability.find(av => av.name === name);
        var b = basics.find(b => b.name === name);

        if(marker.isOpen){
            infowindow.close();
            marker.isOpen = false;
        } else {
            infowindow.close();
            infowindow.setContent(`
                <div class="card" style="width: 18rem; margin:0;">
                    <div class="card-body">
                        <h5 class="card-title">${name}</h5>
                        <p class="card-text">
                            ì´ êµ¬íš: ${a ? a.total : b.total}<br>
                            ê°€ìš© êµ¬íš: ${a ? a.available : 'N/A'}<br>
                            ì œê³µ ì‹œê°„: ${a ? a.time : '-'}
                        </p>
                    </div>
                </div>
            `);
            infowindow.open(map, marker);
            marker.isOpen = true;
        }
    }

    // âœ… ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™ ë° InfoWindow ì—´ê¸°
    document.querySelectorAll('.parking-item').forEach(function(item){
        item.addEventListener('click', function(){
            var name = this.getAttribute('data-name');
            var marker = markerMap[name];
            if(marker){
                map.panTo(marker.getPosition());
                toggleInfowindow(marker, name);
            }
        });
    });

</script>

{% endblock %}
