{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    .full-height {
      height: calc(100vh - 56px);
    }

    .sidebar {
      width: 350px;
      background-color: #f8f9fa;
      overflow-y: auto;
    }

    .map-area {
      flex-grow: 1;
      height: 100%;
      position: relative;
    }

    .list-group-item {
      margin: 0;
      padding-left: 12px;
      padding-right: 12px;
      border-left: none;
      border-right: none;
    }

    .sidebar {
      width: 350px;
      height: calc(100vh - 56px);
      display: flex;
      flex-direction: column;
    }

    .sidebar h5 {
      height: 4rem;
      line-height: 2rem;
      margin: 0;
      padding: 0 1rem;
      border-bottom: 1px solid #dee2e6;
      flex-shrink: 0;
    }

    .sidebar ul.list-group {
      flex-grow: 1;
      overflow-y: auto;
      margin: 0;
      padding: 0;
    }

    .location-button {
      position: absolute;
      bottom: 30px;
      right: 10px;
      z-index: 10;
      width: 40px;
      height: 40px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 5px;
      cursor: pointer;
      box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .location-button img {
      width: 22px;
      height: 22px;
    }

    .map-toggle-controls {
    position: absolute;
    top: 3px;
    right: 10px;
    z-index: 10;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    display: flex; /* ê°€ë¡œ ë°°ì¹˜ */
    gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
    align-items: center;
}

.map-toggle-controls button {
    background: white;
    border: none;
    cursor: pointer;
    padding: 3px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.map-toggle-controls button img {
    width: 30px;
    height: 30px;
}




     .slider-left {
        animation-duration: 0.3s;
        animation-name: slide-in-from-left;
        animation-fill-mode: forwards;
    }

    @keyframes slide-in-from-left {
        from {
            transform: translateX(0);
        }
        to {
            transform: translateX(-100%);
        }
    }

    .slider-right {
        animation-duration: 0.3s;
        animation-name: slide-in-from-right;
        animation-fill-mode: forwards;
    }

    @keyframes slide-in-from-right {
        from {
            transform: translateX(-100%);
        }
        to {
            transform: translateX(0);
        }
    }

    #sidebar {
        position: fixed;
        width: 350px;
        z-index: 3
    }

    #sidebar_toggle {
        background-color: white;
        position: absolute;
        top: 50%;
        right: -20px;
        width: 20px;
        height: 50px;
        padding: 0;
        margin: 0;
        border-bottom-right-radius: 5px;
        border-top-right-radius: 5px;
        border: 0;
    }

</style>

<div class="container-fluid p-0 m-0">
    <div class="d-flex full-height">

        <div id="sidebar">
            <!-- ğŸ…¿ï¸ ì™¼ìª½ ì£¼ì°¨ì¥ ëª©ë¡ -->
            <div class="sidebar d-flex flex-column">
                <!-- ê²€ìƒ‰ì°½ + ê²€ìƒ‰ ê²°ê³¼ -->
                <div class="mt-1 px-2">
                  <div class="input-group">
                    <input type="text" class="form-control" id="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="btn btn-primary" id="search-btn" type="button">ê²€ìƒ‰</button>
                  </div>
                  <ul id="autocomplete-results" class="list-group list-group-flush mt-2"
                      style="max-height: 200px; overflow-y: auto;"></ul>
                </div>


                <ul id="parking-list" class="list-group list-group-flush flex-grow-1 overflow-auto">
                  {% for b in basics %}
                  <li class="list-group-item parking-item" data-name="{{ b.name }}">
                      <div class="fw-bold">{{ b.name }}</div>
                      ì´ êµ¬íš: {{ b.total }}<br>
                      ê°€ìš© ëŒ€ìˆ˜: {{ b.avblPklotCnt }}<br>
                      ì œê³µ ì‹œê°„: {{ b.ocrnDt }}<br>
                  </li>
                  {% endfor %}
                </ul>
            </div>

            <button id="sidebar_toggle" onclick="toggle_sidebar()">
                <
            </button>
        </div>

        <div class="map-area">
            <div id="map" style="width:100%; height:100%;"></div>
            <div class="map-toggle-controls">
                <button onclick="toggleParkingMarkers()" id="parkingToggleBtn" style="background-color:#ddd"><img
                        src="{% static 'imgs/parking-area.png' %}" alt="ì£¼ì°¨ì¥" width="30"></button>

                <button onclick="toggleCCTVMarkers()" id="cctvToggleBtn" style="background-color:#ddd"><img
                        src="{% static 'imgs/security-camera.png' %}" alt="CCTV" width="30"></button>


            </div>
            <button class="location-button" onclick="moveToCurrentLocation()">
                <img src="{% static 'imgs/location_icon.png' %}" alt="ë‚´ ìœ„ì¹˜">
            </button>

        </div>
    </div>
</div>
    <!-- ğŸ“Œ Kakao ì§€ë„ API -->
    <script type="text/javascript"
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=863559e6bebce003983f160e07c1ac27&libraries=services"></script>

    <!-- ì‚¬ì´ë“œë°” ìŠ¬ë¼ì´ë”© -->
    <script>

        let state = true;

        function toggle_sidebar() {
            if (state) {
                $("#sidebar_toggle").text(">");
                $("#sidebar").addClass("slider-left").removeClass("slider-right");
            } else {
                $("#sidebar_toggle").text("<");
                $("#sidebar").addClass("slider-right").removeClass("slider-left");
            }

            state = !state;
        }

    </script>

    <script>
    // ================== ë¡œê·¸ì¸ ì—¬ë¶€ í”Œë˜ê·¸ ==================
    const IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};

    // ================== ì¦ê²¨ì°¾ê¸° ì „ì—­ ê´€ë¦¬ ==================
    let FAVORITE_SET = new Set();
    let CSRF_TOKEN = null;

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function loadFavorites() {
      if (!IS_AUTHENTICATED) {
        FAVORITE_SET = new Set();
        return;
      }
      try {
        const res = await fetch('/favorites/ids/', { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        if (data.ok) {
          FAVORITE_SET = new Set((data.ids || []).map(String));
          CSRF_TOKEN = data.csrfToken || getCookie('csrftoken');
        }
      } catch (e) {
        console.error(e);
      }
    }

    function setStarIcon(btnEl) {
      const pk = btnEl?.dataset?.pk;
      if (!pk) return;
      const icon = btnEl.querySelector('.star-icon');
      if (!icon) return;
      if (!IS_AUTHENTICATED) {
        icon.textContent = 'â˜†';
        return;
      }
      icon.textContent = FAVORITE_SET.has(String(pk)) ? 'â­' : 'â˜†';
    }

    // í´ë¦­ ì‹œ ì¦ê²¨ì°¾ê¸° í† ê¸€
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.favorite-btn');
      if (!btn) return;

      if (!IS_AUTHENTICATED) {
        alert('ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
        return;
      }

      const pk = btn.dataset.pk;
      const icon = btn.querySelector('.star-icon');

      try {
        const res = await fetch(`/favorites/${pk}/toggle/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': CSRF_TOKEN || getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
          },
          credentials: 'same-origin'
        });

        if (res.status === 403) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }
        const data = await res.json();
        if (!data.ok) {
          alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        if (data.status === 'added') {
          FAVORITE_SET.add(String(pk));
          if (icon) icon.textContent = 'â­';
        } else {
          FAVORITE_SET.delete(String(pk));
          if (icon) icon.textContent = 'â˜†';
        }
      } catch (err) {
        console.error(err);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ================== ì§€ë„ ë¡œì§ ==================
    const mapContainer = document.getElementById('map');
    const fixedLat = 37.6822186;
    const fixedLng = 126.769498;
    let currentMarker = null;
    let currentCircle = null;

    const locPosition = new kakao.maps.LatLng(fixedLat, fixedLng);
    const mapOption = { center: locPosition, level: 4 };
    const map = new kakao.maps.Map(mapContainer, mapOption);

    map.setMaxLevel(4);
    map.setCopyrightPosition(kakao.maps.CopyrightPosition.BOTTOMRIGHT, true);

    const basics = JSON.parse('{{ basics_json|escapejs }}');
    const cameras = JSON.parse('{{ cctv_json|escapejs }}');
    const availability = JSON.parse('{{ availability_json|escapejs }}');

    const infowindow = new kakao.maps.InfoWindow({});
    const markerMap = {};
    const markerById = {};
    const basicsById = {};

    // âœ… ì£¼ì°¨ì¥ / CCTV ë§ˆì»¤ ë°°ì—´ê³¼ ìƒíƒœ ë³€ìˆ˜
    let parkingMarkers = [];
    let cctvMarkers = [];
    let parkingVisible = true;
    let cctvVisible = true;

    const parkingMarkerImage = new kakao.maps.MarkerImage(
      "{% static 'imgs/parking-area.png' %}",
      new kakao.maps.Size(35, 35),
      { offset: new kakao.maps.Point(20, 40) }
    );

    currentMarker = new kakao.maps.Marker({
        position: locPosition,
        map: map,
        title: 'ë‚´ìœ„ì¹˜'
    });

    currentCircle = new kakao.maps.Circle({
        center: locPosition,
        radius: 200,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        fillColor: '#FF0000',
        fillOpacity: 0.1,
        map: map
    });

    // ================== ì£¼ì°¨ì¥ ë§ˆì»¤ ë“±ë¡ ==================
    basics.forEach(b => {
      const idStr = String(b.id);
      basicsById[idStr] = b;
      const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(b.lat, b.lng),
          title: b.name,
          map: map,
          image: parkingMarkerImage
      });
      marker.isOpen = false;
      markerMap[b.name] = marker;
      markerById[idStr] = marker;

      parkingMarkers.push(marker);   // âœ… ë°°ì—´ì— ì €ì¥

      kakao.maps.event.addListener(marker, 'click', () => {
          toggleInfowindow(marker, b.name);
      });
    });

    const cameraMarkerImage = new kakao.maps.MarkerImage(
      "{% static 'imgs/security-camera.png' %}",
      new kakao.maps.Size(30, 30)
    );

    // ================== CCTV ë§ˆì»¤ ë“±ë¡ ==================
    cameras.forEach(c => {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(c.lat, c.lng),
            title: c.name,
            map: map,
            image: cameraMarkerImage
        });

        marker.isOpen = false;
        cctvMarkers.push(marker);   // âœ… ë°°ì—´ì— ì €ì¥

        kakao.maps.event.addListener(marker, 'click', () => {
            if (marker.isOpen) {
                infowindow.close();
                marker.isOpen = false;
            } else {
                infowindow.close();
                infowindow.setContent(`
                    <div class="card" style="width: 18rem; margin:0;">
                        <div class="card-body">
                            <h5 class="card-title">${c.name}</h5>
                        </div>
                    </div>
                `);
                infowindow.open(map, marker);
                marker.isOpen = true;
            }
        });
    });

    // ================== í† ê¸€ í•¨ìˆ˜ ==================
    function toggleParkingMarkers() {
      parkingVisible = !parkingVisible;
      parkingMarkers.forEach(m => m.setMap(parkingVisible ? map : null));
      document.getElementById('parkingToggleBtn').style.backgroundColor = parkingVisible ? "#ddd" : "white";
    }

    function toggleCCTVMarkers() {
      cctvVisible = !cctvVisible;
      cctvMarkers.forEach(m => m.setMap(cctvVisible ? map : null));
      document.getElementById('cctvToggleBtn').style.backgroundColor = cctvVisible ? "#ddd" : "white";
    }

    // ================== ì¸í¬ìœˆë„ìš° ==================
    function toggleInfowindow(marker, name) {
      const b = basics.find(b => b.name === name);
      if (!b) return;

      if (marker.isOpen) {
          infowindow.close();
          marker.isOpen = false;
      } else {
          infowindow.close();

          const starChar = IS_AUTHENTICATED
            ? (FAVORITE_SET.has(String(b.id)) ? 'â­' : 'â˜†')
            : 'â˜†';

          infowindow.setContent(`
              <div class="card shadow-sm" style="width: 300px; font-size: 14px; overflow-x: hidden;">
                  <div class="card-header bg-primary text-white fw-bold">
                    <div class="d-flex justify-content-between align-items-center">
                      <span>${b.name}</span>
                        <button class="btn btn-sm btn-light favorite-btn" data-pk="${b.id}" title="ì¦ê²¨ì°¾ê¸°" style="line-height:1">
                          <span class="star-icon">${starChar}</span>
                        </button>
                    </div>
                  </div>

                  <div class="card-body p-2">
                      <div class="row gx-0 text-center mb-2">
                          <div class="col-6 border-end">
                              <div class="fw-bold">ì´ ë©´ìˆ˜</div>
                              <div>${b.total}</div>
                          </div>
                          <div class="col-6 bg-success text-white">
                              <div class="fw-bold">ê°€ìš© ë©´ìˆ˜</div>
                              <div>${b.avblPklotCnt}</div>
                          </div>
                      </div>
                      <hr>
                      <table class="table table-sm mb-0">
                          <tbody>
                              <tr>
                                  <th scope="row">ì£¼ì†Œ</th>
                                  <td>${b.address || 'ì •ë³´ ì—†ìŒ'}</td>
                              </tr>
                              <tr>
                                  <th scope="row">ìš´ì˜ì‹œê°„</th>
                                  <td>
                                      í‰ì¼: ${b.weekdayTime || '-'}<br>
                                      í† ìš”ì¼: ${b.saturdayTime || '-'}<br>
                                      íœ´ì¼: ${b.holidayTime || '-'}
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">ì£¼ì°¨ìš”ê¸ˆ</th>
                                  <td>
                                      ê¸°ë³¸: ${b.basicRate || '-'}<br>
                                      ì¶”ê°€: ${b.addRate || '-'}
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
          `);

          infowindow.open(map, marker);
          marker.isOpen = true;

          kakao.maps.event.addListener(infowindow, 'domready', function() {
            const btn = document.querySelector('.favorite-btn[data-pk="' + b.id + '"]');
            if (btn) setStarIcon(btn);
          });
      }
    }

    // ================== ë¦¬ìŠ¤íŠ¸ í´ë¦­ í¬ì»¤ìŠ¤ ==================
    document.querySelectorAll('.parking-item').forEach(item => {
        item.addEventListener('click', () => {
            const name = item.getAttribute('data-name');
            const marker = markerMap[name];
            if (marker) {
                map.panTo(marker.getPosition());
                toggleInfowindow(marker, name);
            }
        });
    });

    // ================== ìœ„ì¹˜ ì´ë™ ==================
    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // âœ… ì£¼ì°¨ì¥ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§
    function renderParkingList(sortedBasics) {
        const listContainer = document.getElementById('parking-list');
        listContainer.innerHTML = ''; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ë¹„ìš°ê¸°

        sortedBasics.forEach(b => {
            const li = document.createElement('li');
            li.className = 'list-group-item parking-item';
            li.dataset.name = b.name;
            li.innerHTML = `
                <div class="fw-bold">${b.name}</div>
                ì´ êµ¬íš: ${b.total}<br>
                ê°€ìš© ëŒ€ìˆ˜: ${b.avblPklotCnt}<br>
                ì œê³µ ì‹œê°„: ${b.ocrnDt}<br>
            `;
            // í´ë¦­ ì‹œ ë§ˆì»¤ ì´ë™
            li.addEventListener('click', () => {
                const marker = markerMap[b.name];
                if (marker) {
                    map.panTo(marker.getPosition());
                    toggleInfowindow(marker, b.name);
                }
            });
            listContainer.appendChild(li);
        });
    }




// âœ… í˜„ì¬ ìœ„ì¹˜ ì´ë™ í•¨ìˆ˜ ìˆ˜ì •


  function focusAndOpenById(id) {
    const key = String(id);
    const b = basicsById[key], m = markerById[key];
    if (!b || !m) return false;
    map.panTo(m.getPosition());
    toggleInfowindow(m, b.name);
    return true;
  }
  function focusAndOpenByName(name) {
    const m = markerMap[name];
    if (!m) return false;
    map.panTo(m.getPosition());
    toggleInfowindow(m, name);
    return true;
  }
  function initFocusFromUrl() {
    const params = new URLSearchParams(location.search);
    const focusId = params.get('focus_id');
    const focusName = params.get('focus');
    if (focusId) {
      if (!focusAndOpenById(focusId) && focusName) focusAndOpenByName(focusName);
    } else if (focusName) {
      focusAndOpenByName(focusName);
    }
  }
  // âœ… ì„¸ì…˜ ê¸°ë°˜ í¬ì»¤ìŠ¤(ì£¼ì†Œì°½ì€ ê¹”ë”í•˜ê²Œ ìœ ì§€)
  function focusFromSession() {
    const id = sessionStorage.getItem('focus_id');
    if (id) {
      focusAndOpenById(id);
      sessionStorage.removeItem('focus_id');
    }
  }

  function moveToCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const newPosition = new kakao.maps.LatLng(lat, lng);

          map.setCenter(newPosition);

          if (currentMarker) currentMarker.setMap(null);
          if (currentCircle) currentCircle.setMap(null);

          currentMarker = new kakao.maps.Marker({
            position: newPosition,
            map: map,
            title: 'í˜„ì¬ ìœ„ì¹˜'
          });

          currentCircle = new kakao.maps.Circle({
            center: newPosition,
            radius: 200,
            strokeWeight: 2,
            strokeColor: '#FF0000',
            strokeOpacity: 0.7,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map
          });

      // ğŸ“Œ ì£¼ì°¨ì¥ ê±°ë¦¬ ê¸°ì¤€ ì •ë ¬
      const sortedBasics = basics
        .map(b => ({
          ...b,
          distance: getDistance(lat, lng, b.lat, b.lng)
        }))
        .sort((a, b) => a.distance - b.distance);

      // ğŸ“Œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
      renderParkingList(sortedBasics);

      // ğŸ“Œ CCTV ê·¼ì²˜ ì•Œë¦¼
      let cctvNear = false;
      for (let c of cameras) {
        const distance = getDistance(lat, lng, c.lat, c.lng);
        if (distance <= 200) {
          cctvNear = true;
          break;
        }
      }

          if (cctvNear) {
            alert("âš ï¸ ì£¼ì˜: í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ 200m ì´ë‚´ì— CCTVê°€ ìˆìŠµë‹ˆë‹¤.");
          }

        }, function(error) {
          alert("ğŸ“µ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          console.error(error);
        });
      } else {
        alert("ğŸš« ìœ„ì¹˜ ì •ë³´ ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•œ ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
      }
    }

    const searchInput = document.getElementById('search-input');
const autocompleteResults = document.getElementById('autocomplete-results');
const ps = new kakao.maps.services.Places(); // ì¹´ì¹´ì˜¤ ì¥ì†Œ ê²€ìƒ‰
let searchMarkers = [];

// ê¸°ì¡´ ë§ˆì»¤ ì œê±°
function removeSearchMarkers() {
  searchMarkers.forEach(marker => marker.setMap(null));
  searchMarkers = [];
  infowindow.close();
}

// ê²€ìƒ‰ ìˆ˜í–‰ í›„ ë§ˆì»¤ í‘œì‹œ
function showPlaceOnMap(place) {
  removeSearchMarkers();

  const marker = new kakao.maps.Marker({
    map,
    position: new kakao.maps.LatLng(place.y, place.x),
    title: place.place_name
  });

  searchMarkers.push(marker);
  map.panTo(marker.getPosition());

  infowindow.setContent(`
    <div style="padding:5px; font-size:14px; max-width:250px;">
      <strong>${place.place_name}</strong><br>
      ${place.road_address_name || place.address_name || ''}<br>
      <a href="https://map.kakao.com/link/map/${place.id}" target="_blank" style="color:#3c80f6;">
        ì§€ë„ ìƒì„¸ë³´ê¸°
      </a>
    </div>
  `);
  infowindow.open(map, marker);

  // ğŸ“Œ ê²€ìƒ‰ ìœ„ì¹˜ ê¸°ì¤€ ì£¼ì°¨ì¥ ì •ë ¬
  const lat = parseFloat(place.y);
  const lng = parseFloat(place.x);

  const sortedBasics = basics
    .map(b => ({
      ...b,
      distance: getDistance(lat, lng, b.lat, b.lng)
    }))
    .sort((a, b) => a.distance - b.distance);

  renderParkingList(sortedBasics);
}


// ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì‹¤ì‹œê°„ í˜¸ì¶œ)
searchInput.addEventListener('input', () => {
  const keyword = searchInput.value.trim();
  autocompleteResults.innerHTML = '';

  if (!keyword) return;

  ps.keywordSearch(keyword, (data, status) => {
    if (status === kakao.maps.services.Status.OK) {
      data.slice(0, 5).forEach(place => { // ìƒìœ„ 5ê°œë§Œ ì¶”ì²œ
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = place.place_name;
        li.addEventListener('click', () => {
          searchInput.value = place.place_name;
          autocompleteResults.innerHTML = '';
          showPlaceOnMap(place); // í´ë¦­ ì‹œ ë§ˆì»¤ í‘œì‹œ
        });
        autocompleteResults.appendChild(li);
      });
    }
  });
});

// ì—”í„°í‚¤ ê²€ìƒ‰
searchInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const firstItem = autocompleteResults.querySelector('li');
    if (firstItem) firstItem.click();
  }
});

  // === (ì¶”ê°€) ì§€ë„ ì›€ì§ì´ê±°ë‚˜ ì¤Œ ë°”ê¾¸ë©´ ì¸í¬ìœˆë„ìš° ë‹«ê¸° ===
  function closeAllInfoWindows() {
    infowindow.close();
    Object.values(markerMap).forEach(m => m.isOpen = false);
    Object.values(markerById).forEach(m => m.isOpen = false);
  }
  kakao.maps.event.addListener(map, 'dragstart', closeAllInfoWindows);
  kakao.maps.event.addListener(map, 'zoom_changed', closeAllInfoWindows);

  // âœ… ì¦ê²¨ì°¾ê¸° ë¡œë“œê°€ ëë‚œ ë’¤ í¬ì»¤ìŠ¤ ì‹¤í–‰
  window.addEventListener('DOMContentLoaded', async () => {
    await loadFavorites();
    initFocusFromUrl();   // ì¿¼ë¦¬ë¡œ ì˜¨ ê²½ìš°(í˜¸í™˜)
    focusFromSession();   // ì„¸ì…˜ìœ¼ë¡œ ì˜¨ ê²½ìš°(ì£¼ì†Œ ê¹”ë”)
  });
</script>

    {% endblock %}
